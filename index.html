<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医药库存管理集成系统</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --bg-color: #f8f9fa;
        }

        body { font-family: 'Microsoft YaHei', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg-color); }

        /* 左侧功能导航栏 */
        .sidebar { width: 220px; background: #343a40; color: white; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 25px 20px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #454d55; background: #2c3136; }
        .nav-btn { border: none; background: none; color: #adb5bd; padding: 18px 25px; text-align: left; cursor: pointer; transition: 0.3s; font-size: 16px; border-left: 4px solid transparent; }
        .nav-btn:hover { background: #495057; color: white; }
        .nav-btn.active { background: #495057; color: white; border-left-color: var(--primary-color); background-color: rgba(0,123,255,0.1); }

        /* 右侧内容区 */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; box-sizing: border-box; }
        .module-section { display: none; }
        .module-section.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eef0f2; }
        h2 { margin-top: 0; color: #333; border-left: 5px solid var(--primary-color); padding-left: 15px; margin-bottom: 20px; font-size: 20px; }
        .controls { margin: 20px 0; padding: 20px; background: #f1f3f5; border-radius: 8px; }
        .controls label { font-weight: bold; display: block; margin-bottom: 10px; color: #495057; }
        
        button { border: none; padding: 10px 22px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-right: 12px; transition: all 0.2s; }
        .btn-execute { background-color: var(--success-color); color: white; }
        .btn-execute:hover { background-color: #218838; transform: translateY(-1px); }
        .btn-export { background-color: var(--primary-color); color: white; }
        .btn-export:hover { background-color: #0069d9; transform: translateY(-1px); }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; transform: none !important; opacity: 0.7; }

        .table-container { overflow-x: auto; margin-top: 15px; border: 1px solid #dee2e6; border-radius: 4px; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 1000px; }
        th, td { border: 1px solid #dee2e6; padding: 12px 10px; text-align: left; font-size: 13px; white-space: nowrap; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; color: #495057; }
        
        .inner-tabs { margin-bottom: -1px; margin-top: 25px; display: flex; }
        .inner-tab { background: #e9ecef; border: 1px solid #dee2e6; padding: 10px 20px; cursor: pointer; border-bottom: none; border-radius: 6px 6px 0 0; margin-right: 5px; font-size: 14px; color: #6c757d; }
        .inner-tab.active { background: white; font-weight: bold; border-top: 3px solid var(--primary-color); color: var(--primary-color); }
        
        .verify-msg { margin-top: 15px; padding: 15px; border-radius: 6px; display: none; font-size: 14px; line-height: 1.6; }
        .verify-success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; display: block; }
        .verify-error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; display: block; }
        .hint-text { color: #666; font-size: 13px; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">库存集成管理系统</div>
        <button class="nav-btn" id="nav-mod1" onclick="switchModule('module1')">一级库存</button>
        <button class="nav-btn" id="nav-mod2" onclick="switchModule('module2')">二级库存</button>
        <button class="nav-btn active" id="nav-mod3" onclick="switchModule('module3')">二级流向</button>
    </div>

    <div class="main-content">
        <div id="module1" class="module-section">
            <div class="card">
                <h2>一级库存核算 (购进数量 - 销售数量)</h2>
                <div class="controls">
                    <label>上传Excel（需包含“购进”和“销售”工作表）：</label>
                    <input type="file" id="invLevel1File" accept=".xlsx, .xls">
                    <button id="calcInv1Btn" class="btn-execute" disabled>执行核算对账</button>
                    <button id="exportInv1Btn" class="btn-export" disabled>导出完整报表</button>
                    <div id="inv1Summary" class="hint-text">等待文件上传...</div>
                    <div id="inv1Verify" class="verify-msg"></div>
                </div>

                <div class="inner-tabs">
                    <button class="inner-tab active" onclick="switchSubTab(event, 'inv1_res', 'module1')">库存表 (结果)</button>
                    <button class="inner-tab" onclick="switchSubTab(event, 'inv1_buy', 'module1')">购进原表明细</button>
                    <button class="inner-tab" onclick="switchSubTab(event, 'inv1_sale', 'module1')">销售原表明细</button>
                </div>

                <div id="inv1_res" class="table-container sub-tab-module1" style="display:block;">
                    <table>
                        <thead><tr><th>商品编号</th><th>通用名</th><th>规格</th><th>批号</th><th>生产日期</th><th>有效期至</th><th>库存数量</th></tr></thead>
                        <tbody id="inv1ResBody"></tbody>
                    </table>
                </div>
                <div id="inv1_buy" class="table-container sub-tab-module1" style="display:none;">
                    <table>
                        <thead><tr><th>商品编号</th><th>通用名</th><th>规格</th><th>批号</th><th>生产日期</th><th>有效期至</th><th>购进数量</th></tr></thead>
                        <tbody id="inv1BuyBody"></tbody>
                    </table>
                </div>
                <div id="inv1_sale" class="table-container sub-tab-module1" style="display:none;">
                    <table>
                        <thead><tr><th>商品编号</th><th>通用名</th><th>规格</th><th>批号</th><th>生产日期</th><th>有效期至</th><th>销售数量</th></tr></thead>
                        <tbody id="inv1SaleBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="module2" class="module-section">
            <div class="card">
                <h2>二级库存核算 (商业公司维度)</h2>
                <div class="controls">
                    <label>上传Excel（需包含“购进”和“销售”工作表）：</label>
                    <input type="file" id="invLevel2File" accept=".xlsx, .xls">
                    <button id="calcInv2Btn" class="btn-execute" disabled>执行核算对账</button>
                    <button id="exportInv2Btn" class="btn-export" disabled>导出核算报表</button>
                    <div id="inv2Summary" class="hint-text">等待文件上传...</div>
                    <div id="inv2Verify" class="verify-msg"></div>
                </div>

                <div class="inner-tabs">
                    <button class="inner-tab active" onclick="switchSubTab(event, 'inv2_res', 'module2')">库存核算结果</button>
                    <button class="inner-tab" onclick="switchSubTab(event, 'inv2_buy', 'module2')">购进明细</button>
                    <button class="inner-tab" onclick="switchSubTab(event, 'inv2_sale', 'module2')">销售明细</button>
                </div>

                <div id="inv2_res" class="table-container sub-tab-module2" style="display:block;">
                    <table>
                        <thead><tr><th>商业公司新</th><th>产品名称</th><th>批号</th><th>库存数量</th></tr></thead>
                        <tbody id="inv2ResBody"></tbody>
                    </table>
                </div>
                <div id="inv2_buy" class="table-container sub-tab-module2" style="display:none;">
                    <table>
                        <thead><tr><th>商业公司新</th><th>产品名称</th><th>批号</th><th>销售数量</th></tr></thead>
                        <tbody id="inv2BuyBody"></tbody>
                    </table>
                </div>
                <div id="inv2_sale" class="table-container sub-tab-module2" style="display:none;">
                    <table>
                        <thead><tr><th>商业公司新</th><th>产品名称</th><th>批号</th><th>销售数量</th></tr></thead>
                        <tbody id="inv2SaleBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="module3" class="module-section active">
            <div class="card">
                <h2>二级流向分配 (2/5倍数优化)</h2>
                <div class="controls">
                    <label>上传Excel（需包含“库存”和“客户”工作表）：</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
                    <button id="allocateBtn" class="btn-execute" disabled>执行流向分配</button>
                    <button id="exportBtn" class="btn-export" disabled>导出分配结果</button>
                    <div id="summary" class="hint-text">等待上传文件...</div>
                </div>

                <div class="inner-tabs">
                    <button class="inner-tab active" onclick="switchSubTab(event, 'sub1', 'module3')">分配结果 (表3)</button>
                    <button class="inner-tab" onclick="switchSubTab(event, 'sub2', 'module3')">原始库存 (表1)</button>
                    <button class="inner-tab" onclick="switchSubTab(event, 'sub3', 'module3')">客户额度 (表2)</button>
                </div>

                <div id="sub1" class="table-container sub-tab-module3" style="display:block;">
                    <table>
                        <thead><tr><th>日期</th><th>商业公司</th><th>客户名称</th><th>产品名称</th><th>产品批号</th><th>总量</th><th>生产日期</th><th>有效期</th><th>单价</th><th>金额</th></tr></thead>
                        <tbody id="allocationBody"></tbody>
                    </table>
                </div>
                <div id="sub2" class="table-container sub-tab-module3" style="display:none;">
                    <table>
                        <thead><tr><th>商业公司</th><th>产品名称</th><th>产品批号</th><th>库存总量</th><th>生产日期</th><th>有效期至</th><th>单价</th></tr></thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                </div>
                <div id="sub3" class="table-container sub-tab-module3" style="display:none;">
                    <table>
                        <thead><tr><th>商业公司</th><th>客户名称</th><th>剩余额度</th></tr></thead>
                        <tbody id="clientsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 导航与切换逻辑 ---
        function switchModule(moduleId) {
            document.querySelectorAll('.module-section').forEach(m => m.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(moduleId).classList.add('active');
            document.getElementById('nav-' + moduleId.replace('module', 'mod')).classList.add('active');
        }

        function switchSubTab(evt, subId, moduleId) {
            document.querySelectorAll('.sub-tab-' + moduleId).forEach(c => c.style.display = 'none');
            evt.currentTarget.parentNode.querySelectorAll('.inner-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(subId).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }

        // --- 通用：Excel日期处理 ---
        function formatExcelDate(d) {
            if (!d) return "";
            if (typeof d === 'number') {
                const date = new Date(Date.UTC(0, 0, d - 1));
                return date.toISOString().slice(0, 10);
            }
            return d;
        }

        // ==========================================
        // 一级库存逻辑 (Module 1) - 新完善
        // ==========================================
        let inv1BuyData = [], inv1SaleData = [], inv1Calculated = [];

        document.getElementById('invLevel1File').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                const buySheet = workbook.Sheets[workbook.SheetNames.find(n => n.includes('购进'))];
                const saleSheet = workbook.Sheets[workbook.SheetNames.find(n => n.includes('销售'))];

                if (!buySheet || !saleSheet) { alert("必须包含'购进'和'销售'工作表"); return; }

                inv1BuyData = XLSX.utils.sheet_to_json(buySheet).map(r => ({
                    id: r['商品编号'], name: r['通用名'], spec: r['规格'], 
                    batch: r['批号'], dateP: formatExcelDate(r['生产日期']), 
                    dateE: formatExcelDate(r['有效期至']), qty: Number(r['购进数量']) || 0
                }));

                inv1SaleData = XLSX.utils.sheet_to_json(saleSheet).map(r => ({
                    id: r['商品编号'], name: r['通用名'], spec: r['规格'], 
                    batch: r['批号'], dateP: formatExcelDate(r['生产日期']), 
                    dateE: formatExcelDate(r['有效期至']), qty: Number(r['销售数量']) || 0
                }));

                renderTable('inv1BuyBody', inv1BuyData, ['id','name','spec','batch','dateP','dateE','qty']);
                renderTable('inv1SaleBody', inv1SaleData, ['id','name','spec','batch','dateP','dateE','qty']);
                document.getElementById('calcInv1Btn').disabled = false;
                document.getElementById('inv1Summary').innerText = `已加载：购进${inv1BuyData.length}条，销售${inv1SaleData.length}条。`;
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('calcInv1Btn').onclick = function() {
            const map = {};
            inv1BuyData.forEach(r => {
                const key = `${r.id}|${r.name}|${r.spec}|${r.batch}|${r.dateP}|${r.dateE}`;
                map[key] = (map[key] || 0) + r.qty;
            });
            inv1SaleData.forEach(r => {
                const key = `${r.id}|${r.name}|${r.spec}|${r.batch}|${r.dateP}|${r.dateE}`;
                map[key] = (map[key] || 0) - r.qty;
            });

            inv1Calculated = Object.keys(map).map(k => {
                const parts = k.split('|');
                return [...parts, map[k]];
            }).filter(r => r[6] !== 0);

            renderTable('inv1ResBody', inv1Calculated);

            // 验证
            const buySum = inv1BuyData.reduce((s,r)=>s+r.qty,0);
            const saleSum = inv1SaleData.reduce((s,r)=>s+r.qty,0);
            const invSum = inv1Calculated.reduce((s,r)=>s+r[6],0);
            const vDiv = document.getElementById('inv1Verify');
            if(Math.abs((buySum - saleSum) - invSum) < 0.1) {
                vDiv.innerHTML = `<strong>验证成功：</strong>购进(${buySum}) - 销售(${saleSum}) = 库存(${invSum})。记录共${inv1Calculated.length}条。`;
                vDiv.className = "verify-msg verify-success";
            } else {
                vDiv.innerHTML = `<strong>验证失败：</strong>存在对账差额！请检查批号或商品编号是否统一。`;
                vDiv.className = "verify-msg verify-error";
            }
            document.getElementById('exportInv1Btn').disabled = false;
        };

        document.getElementById('exportInv1Btn').onclick = function() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['商品编号','通用名','规格','批号','生产日期','有效期至','库存数量'], ...inv1Calculated]), "库存结果");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inv1BuyData), "原始购进");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inv1SaleData), "原始销售");
            XLSX.writeFile(wb, `一级库存核算_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        // ==========================================
        // 二级库存逻辑 (Module 2)
        // ==========================================
        let buy2Data = [], sale2Data = [], inv2Calculated = [];
        document.getElementById('invLevel2File').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                const bS = workbook.Sheets[workbook.SheetNames.find(n => n.includes('购进'))];
                const sS = workbook.Sheets[workbook.SheetNames.find(n => n.includes('销售'))];
                buy2Data = XLSX.utils.sheet_to_json(bS).map(r => ({ co: r['商业公司新'], p: r['产品名称'], b: r['批号'], q: Number(r['销售数量']) || 0 }));
                sale2Data = XLSX.utils.sheet_to_json(sS).map(r => ({ co: r['商业公司新'], p: r['产品名称'], b: r['批号'], q: Number(r['销售数量']) || 0 }));
                renderTable('inv2BuyBody', buy2Data, ['co','p','b','q']);
                renderTable('inv2SaleBody', sale2Data, ['co','p','b','q']);
                document.getElementById('calcInv2Btn').disabled = false;
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('calcInv2Btn').onclick = function() {
            const m = {};
            buy2Data.forEach(r => { const k=`${r.co}|${r.p}|${r.b}`; m[k] = (m[k]||0)+r.q; });
            sale2Data.forEach(r => { const k=`${r.co}|${r.p}|${r.b}`; m[k] = (m[k]||0)-r.q; });
            inv2Calculated = Object.keys(m).map(k => [...k.split('|'), m[k]]).filter(r => r[3]!==0);
            renderTable('inv2ResBody', inv2Calculated);
            document.getElementById('inv2Verify').innerHTML = "二级对账完成";
            document.getElementById('inv2Verify').className = "verify-msg verify-success";
            document.getElementById('exportInv2Btn').disabled = false;
        };

        document.getElementById('exportInv2Btn').onclick = function() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['商业公司新','产品名称','批号','库存数量'], ...inv2Calculated]), "结果");
            XLSX.writeFile(wb, `二级库存_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        // ==========================================
        // 二级流向逻辑 (Module 3) - 保持2/5倍数及分配逻辑
        // ==========================================
        let flowInv = [], flowCli = [], flowRes = [];
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                const iS = workbook.Sheets[workbook.SheetNames.find(n => n.includes('库存'))];
                const cS = workbook.Sheets[workbook.SheetNames.find(n => n.includes('客户'))];
                flowInv = XLSX.utils.sheet_to_json(iS, {header:1}).slice(1).map(r => [r[0],r[1],r[2],Number(r[3])||0,formatExcelDate(r[4]),formatExcelDate(r[5]),Number(r[6])||0]);
                flowCli = XLSX.utils.sheet_to_json(cS, {header:1}).slice(1).map(r => [r[0],r[1],Number(r[2])||0]);
                renderTable('inventoryBody', flowInv);
                renderTable('clientsBody', flowCli);
                document.getElementById('allocateBtn').disabled = false;
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('allocateBtn').onclick = function() {
            flowRes = [];
            const coInv = {}; flowInv.forEach(r => { if(!coInv[r[0]]) coInv[r[0]]=[]; coInv[r[0]].push(r); });
            const coCli = {}; flowCli.forEach(r => { if(!coCli[r[0]]) coCli[r[0]]=[]; coCli[r[0]].push(r); });
            const today = new Date().toISOString().slice(0,10);

            Object.keys(coInv).forEach(co => {
                let stocks = coInv[co].sort((a,b)=>String(a[2]).localeCompare(String(b[2])));
                let clients = (coCli[co]||[]).sort((a,b)=>b[2]-a[2]);
                if(!clients.length) return;
                const totalQ = clients.reduce((s,c)=>s+c[2],0);

                stocks.forEach(st => {
                    let remain = st[3], dist = 0;
                    clients.forEach(cl => {
                        let ideal = st[3] * (cl[2]/totalQ), final = 0;
                        if(ideal >= 2) {
                            let q5 = Math.floor(ideal/5)*5, q2 = Math.floor(ideal/2)*2;
                            final = q5 > 0 ? q5 : (q2 >= 2 ? q2 : 0);
                        }
                        final = Math.min(final, remain - dist);
                        if(final > 0) {
                            flowRes.push([today, co, cl[1], st[1], st[2], final, st[4], st[5], st[6], (final*st[6]).toFixed(2)]);
                            dist += final;
                        }
                    });
                    if(remain - dist > 0) {
                        let last = flowRes.findLastIndex(r=>r[1]===co && r[4]===st[2]);
                        if(last>-1) { flowRes[last][5] += (remain-dist); flowRes[last][9] = (flowRes[last][5]*st[6]).toFixed(2); }
                        else { flowRes.push([today, co, clients[0][1], st[1], st[2], remain-dist, st[4], st[5], st[6], ((remain-dist)*st[6]).toFixed(2)]); }
                    }
                });
            });
            renderTable('allocationBody', flowRes);
            document.getElementById('exportBtn').disabled = false;
        };

        document.getElementById('exportBtn').onclick = function() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([['日期','商业公司','客户名称','产品名称','产品批号','总量','生产日期','有效期','单价','金额'], ...flowRes]), "分配结果");
            XLSX.writeFile(wb, `二级流向分配_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        // --- 通用：表格渲染辅助 ---
        function renderTable(id, data, keys) {
            const body = document.getElementById(id);
            if (!keys) {
                body.innerHTML = data.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
            } else {
                body.innerHTML = data.map(r => `<tr>${keys.map(k => `<td>${r[k]}</td>`).join('')}</tr>`).join('');
            }
        }
    </script>
</body>
</html>
